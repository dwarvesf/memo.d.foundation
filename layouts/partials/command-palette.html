{{ $img := resources.Get "img/404.png" }}

<script type="module">
  import _groupBy from "https://fastly.jsdelivr.net/npm/lodash.groupby@4.6.0/+esm";

  const getMatchingLines = (s, pattern) => {
    const lines = s.split("\n");
    const regex = new RegExp(pattern);
    const matchingLines = lines
      .filter((line) => regex.test(line))
      .slice(0, 1)
      .map((line) => `${line.split(" ").slice(0, 30).join(" ")}...`);

    return matchingLines;
  };

  document.addEventListener("command-palette-search", (event) => {
    const query = event.detail.data;

    window.getDuckDB().then(async (conn) => {
      console.time("Embedding query");
      const queryEmbeddings = await window.getEmbeddings(query);
      console.timeEnd("Embedding query");

      console.time("Running hybrid search");
      const hybridSearch = await conn.prepare(`
        SELECT
          title,
          description,
          file_path,
          tags,
          md_content,
          spr_content,
          full_text_score,
          similarity,
          (full_text_score * similarity) AS score
        FROM (
          SELECT
            title,
            description,
            file_path,
            tags,
            md_content,
            spr_content,
            fts_main_vault.match_bm25(file_path, ?) AS full_text_score,
            ${window.pipe
          ? `array_cosine_similarity(?::DOUBLE[1024], embeddings_spr_custom)`
          : "?"
        } AS similarity
          FROM vault
          WHERE 
            embeddings_spr_custom IS NOT NULL
            AND full_text_score IS NOT NULL
            AND title IS NOT NULL
            AND tags is NOT NULL
            AND (hiring = true OR hiring IS NULL)
            AND (draft != true OR draft IS NULL)
          ORDER BY similarity DESC
        )
        ORDER BY score DESC
        LIMIT 10;
      `);
      const hybridSearchData = await hybridSearch.query(
        query,
        window.pipe ? JSON.stringify(Array.from(queryEmbeddings.data)) : 1
      );
      const hybridSearchParsedData = window.parseDuckDBData(hybridSearchData);
      const searchResults = hybridSearchParsedData.map((row) => {
        const filePaths = row.file_path.split("/");
        filePaths.pop();
        row.category = filePaths.join(" > ");
        row.matchingLines = getMatchingLines(
          row.md_content,
          query.split(" ").join("|")
        );
        row.spr_content = row.spr_content.replaceAll("\n", "<hr />");
        delete row.md_content;
        return row;
      });
      const grouped = _groupBy(searchResults, "category");
      const event = new CustomEvent("command-palette-search-result", {
        detail: {
          data: {
            grouped,
            flat: Object.values(grouped).flatMap((groupFiles) => groupFiles),
          },
        },
      });
      window.dispatchEvent(event);
      console.log(searchResults);
      console.timeEnd("Running hybrid search");
    });
  });
</script>

<div x-data="{ searching: false, searchBar: false, query: '', searchResults: {}, flat: [], selected: {}, 
    next(container) {
      const curIdx = this.flat.findIndex(f => f.file_path === this.selected.file_path);
      let nextIdx = curIdx + 1;
      if(nextIdx >= this.flat.length) {
        nextIdx = 0;
      }
      this.selected = this.flat[nextIdx];
      const selector = `a[data-searchid='${this.selected.file_path}']`;
      const a = $refs.searchContainer.querySelector(selector)
      a.scrollIntoView({ block: 'nearest', behavior: 'instant'});
    }, 
    prev(container) {
      const curIdx = this.flat.findIndex(f => f.file_path === this.selected.file_path);
      let nextIdx = curIdx - 1;
      if(nextIdx < 0) {
        nextIdx = this.flat.length - 1;
      }
      this.selected = this.flat[nextIdx];
      const selector = `a[data-searchid='${this.selected.file_path}']`;
      const a = $refs.searchContainer.querySelector(selector)
      a.scrollIntoView({ block: 'nearest', behavior: 'instant'});
    },
    set(file) {
      this.selected = file;
    },
    goto() {
      if(!this.selected.file_path) return;
      window.location.pathname = this.selected.file_path.slice(0, -3);
    }
  }" class="cmd-palette">
  <button class="cmd-search-button" @click="searchBar = true">
    <span class="cmd-search-button-text">üîç Search</span>
    <span class="cmd-search-button-keys">
      <kbd class="tag">‚åò</kbd>
      <kbd class="tag">K</kbd>
    </span>
  </button>

  <div @keydown.enter.stop.document="goto()" @keydown.ctrl.j.prevent.document="next()"
    @keydown.ctrl.k.prevent.document="prev()" @keydown.down.stop.document="next()" @keydown.up.stop.document="prev()"
    class="cmd-overlay" :class="searchBar ?'cmd-modal-active' : 'cmd-modal-hidden'" x-ref="searchContainer">
    <div class="cmd-modal" @mousedown.outside="searchBar = false" x-trap.inert.noscroll.noreturn="searchBar">
      <input type="text" x-model="query" placeholder="Search" autocomplete="off" class="cmd-search-input"
        x-ref="searchInput" @input.change="searching = true"
        @input.change.debounce="$dispatch('command-palette-search', { data: $event.target.value })"
        @command-palette-search-result.window="searching = false; searchResults = $event.detail.data.grouped; flat = $event.detail.data.flat; selected = $event.detail.data.flat[0]" />
      <div x-cloak :class="searchBar ?'cmd-results-active' : 'cmd-results-hidden'" class="cmd-results"
        @keydown.meta.k.prevent.document="searchBar = !searchBar; $nextTick(() => $refs.searchInput.focus())"
        @keydown.escape.document="searchBar = false;query=''">
        <div
          :class="Object.keys(searchResults).length !== 0 && query.length !== 0 ? 'cmd-results-list-wrapper' : 'cmd-results-hidden'">
          <ul class="cmd-results-list" x-ref="resultsList">
            <template x-for="group in Object.entries(searchResults)" :key="group[0]">
              <div class="cmd-results-group">
                <span x-text="group[0]"></span>
                <template x-for="result in group[1]" :key="result.file_path">
                  <li @mouseenter="set(result)"
                    :class="{ 'cmd-result-item': true, 'cmd-result-selected': result.file_path.toLowerCase() === selected?.file_path.toLowerCase() }">
                    <a :data-searchid="result.file_path"
                      :href="`/${result.file_path.toLowerCase().replaceAll(' ', '-').replaceAll('.md', '').replaceAll('/_index', '').replaceAll('&', '')}/`">
                      <div class="cmd-result-title" x-text="result.title"></div>
                      <ul class="cmd-matching-lines">
                        <li class="cmd-tags">
                          <template x-for="tag in result.tags">
                            <a class="tag" x-text="tag" :href="`/tag/${tag}`"></a>
                          </template>
                        </li>
                        <template x-for="matchingLine in result.matchingLines">
                          <li class="cmd-matching-line" x-text="matchingLine"></li>
                        </template>
                      </ul>
                    </a>
                  </li>
                </template>
              </div>
            </template>
          </ul>
          <template x-if="Object.keys(searchResults).length > 0 && query.length > 0">
            <div class="cmd-result-preview">
              <div class="cmd-preview-icon">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                  <g fill="currentColor">
                    <path fill-rule="evenodd"
                      d="M4.125 3C3.089 3 2.25 3.84 2.25 4.875V18a3 3 0 0 0 3 3h15a3 3 0 0 1-3-3V4.875C17.25 3.839 16.41 3 15.375 3zM12 9.75a.75.75 0 0 0 0 1.5h1.5a.75.75 0 0 0 0-1.5zm-.75-2.25a.75.75 0 0 1 .75-.75h1.5a.75.75 0 0 1 0 1.5H12a.75.75 0 0 1-.75-.75M6 12.75a.75.75 0 0 0 0 1.5h7.5a.75.75 0 0 0 0-1.5zm-.75 3.75a.75.75 0 0 1 .75-.75h7.5a.75.75 0 0 1 0 1.5H6a.75.75 0 0 1-.75-.75M6 6.75a.75.75 0 0 0-.75.75v3c0 .414.336.75.75.75h3a.75.75 0 0 0 .75-.75v-3A.75.75 0 0 0 9 6.75z"
                      clip-rule="evenodd" />
                    <path d="M18.75 6.75h1.875c.621 0 1.125.504 1.125 1.125V18a1.5 1.5 0 0 1-3 0z" />
                  </g>
                </svg>
              </div>
              <span class="cmd-preview-path" x-text="selected?.category"></span>
              <p class="cmd-preview-title" x-text="selected?.title"></p>
              <p class="cmd-preview-description" x-text="selected?.description"></p>
              <div class="cmd-preview-recap">
                <span>on this page</span>
                <p x-html="selected?.spr_content">
              </div>
            </div>
        </div>
        </template>
      </div>

      <template x-if="!searching && Object.keys(searchResults).length === 0 && query.length > 0">
        <div class="cmd-no-results">
          <img src="{{ $img.RelPermalink }}" />
        </div>
      </template>
      <div class="cmd-instructions">
        Type <kdb class="tag">ESC</kdb> to close search bar
      </div>
    </div>
  </div>
</div>
</div>
