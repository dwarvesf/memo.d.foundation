{{ $img := resources.Get "img/404.png" }}
{{ $pinned := slice }}
{{ range .Site.Pages }}
{{ if .Params.pinned }}
{{ $pinned = $pinned | append (dict "title" .Params.Title "url" .RelPermalink "date" .Page.Params.Date) }}
{{ end }}
{{ end }}

<script type="module">
  import _groupBy from "https://fastly.jsdelivr.net/npm/lodash.groupby@4.6.0/+esm";
  import snarkdown from "https://unpkg.com/snarkdown@2.0.0/dist/snarkdown.es.js";

  const authorRe = /author:([^\s]*)/g;
  const tagRe = /tag:([^\s]*)/g
  const titleRe = /title:([^\s]*)/g;

  const getMatchingLines = (s, pattern) => {
    const lines = s.split("\n");
    const regex = new RegExp(pattern, "gi");
    const matchingLines = lines
      .filter((line) => regex.test(line))
      .slice(0, 1);

    if (!matchingLines.length) return "";

    // Custom function to convert Markdown to plain text without creating HTML elements
    const markdownToPlainText = (markdown) => {
      // Remove image Markdown syntax
      let text = markdown.replace(/!\[.*?\]\(.*?\)/g, '');
      // Remove link Markdown syntax, keeping only the link text
      text = text.replace(/\[([^\]]+)\]\(.*?\)/g, '$1');
      // Remove other Markdown syntax
      text = text.replace(/[*_~`#]/g, '');
      return text;
    };

    let str = markdownToPlainText(matchingLines[0]);

    // Highlight matching parts
    str = str.replace(regex, "<span>$&</span>");

    if (str.length <= 100) return `...${str}...`;

    // Trim the string to around 100 characters
    let trimmed = str.slice(0, 100);
    let lastSpaceIndex = trimmed.lastIndexOf(' ');
    
    // Ensure we don't cut off in the middle of a highlight
    while (lastSpaceIndex > 0) {
      let substring = trimmed.substring(0, lastSpaceIndex);
      if (substring.split('<span>').length === substring.split('</span>').length) {
        break;
      }
      lastSpaceIndex = trimmed.lastIndexOf(' ', lastSpaceIndex - 1);
    }

    return `...${trimmed.slice(0, lastSpaceIndex)}...`;
  };

  const parseQueryForFilters = (query) => {
    const filters = {authors: [], tags: [], title: ""}
    const stripFilters = query.split(" ").filter(token => {
      const titleMatch = [...token.matchAll(titleRe)];

      const authorMatch = [...token.matchAll(authorRe)];
      if (authorMatch?.length) {
        filters.authors = filters.authors.concat(authorMatch.map(m => m[1]));
        console.log(filters.authors)
        return false;
      }
      const tagMatch = [...token.matchAll(tagRe)];
      if (tagMatch?.length) {
        filters.tags = filters.tags.concat(tagMatch.map(m => m[1]));
        return false;
      }

      if (titleMatch?.length) {
        filters.title = titleMatch[0][1];
        return false;
      }

      return true;
    })

    return {filters, query: stripFilters.join(" ").trim()};
  }
  
  function calculateRRFScore(fullTextRank, similarityRank, k = 60) {
    return 1 / (k + fullTextRank) + 1 / (k + similarityRank);
  }

  document.addEventListener("command-palette-search", async (event) => {
    const rawQuery = event.detail.data;
    const {filters, query} = parseQueryForFilters(rawQuery);
    
    // Check if the query is in cache
    const cachedResult = sessionStorage.getItem(rawQuery);
    if (cachedResult) {
      console.log("Retrieving results from cache");
      const parsedResult = JSON.parse(cachedResult);
      dispatchSearchResults(parsedResult);
      return;
    }

    const queryEmbeddings = await window.getEmbeddings(query);

    try {
      console.time("Running hybrid search");
      const queryStr = `
        SELECT
          title,
          description,
          file_path,
          tags,
          md_content,
          spr_content,
          fts_main_vault.match_bm25(file_path, '${query}') AS full_text_score,
          ${queryEmbeddings ? `array_cosine_similarity(${JSON.stringify(Array.from(queryEmbeddings.data))}::FLOAT[1024], embeddings_spr_custom)` : "1"} AS similarity
        FROM vault
        WHERE
          embeddings_spr_custom IS NOT NULL
          AND title IS NOT NULL
          ${filters.title ? `AND title ILIKE '%${filters.title}%'` : ""}
          AND tags IS NOT NULL
          ${filters.tags.length ? `AND tags @> '${JSON.stringify(filters.tags)}'::jsonb` : ""}
          AND (NOT hiring OR hiring IS NULL)
          AND (NOT draft OR draft IS NULL)
          ${filters.authors.length ? `AND authors @> '${JSON.stringify(filters.authors)}'::jsonb` : ""}
        ORDER BY 
          full_text_score DESC,
          similarity DESC
        LIMIT 10;
      `;

      const response = await window.queryAPI(queryStr);
      const hybridSearchParsedData = response.result;

      const searchResults = hybridSearchParsedData.map((row) => {
        const filePaths = row.file_path.split("/");
        filePaths.pop();
        row.category = filePaths.join(" > ");
        row.matchingLines = getMatchingLines(
          row.md_content,
          query.split(" ").join("|")
        );
        row.spr_content = row.spr_content?.replaceAll("\n", "<hr />");

        delete row.md_content;
        return row;
      });

      const grouped = _groupBy(searchResults, "category");
      const result = {
        grouped,
        flat: Object.values(grouped).flatMap((groupFiles) => groupFiles),
      };

      // Cache the result
      sessionStorage.setItem(rawQuery, JSON.stringify(result));

      dispatchSearchResults(result);
      console.log(searchResults);
      console.timeEnd("Running hybrid search");
    } catch (error) {
      console.error("Error running search:", error);
    }
  });

  function dispatchSearchResults(result) {
    const event = new CustomEvent("command-palette-search-result", {
      detail: { data: result },
    });
    window.dispatchEvent(event);
  }
</script>

<div x-data="{ 
    searching: false, 
    searchPlaceholder: 'Initializing Search...', 
    searchBar: false, 
    query: '', 
    searchResults: {}, 
    flat: [], 
    selected: {}, 
    recentPages: [],
    selectedRecent: null,
    selectedSection: 'recents', // 'recents', 'welcome', 'suggestions', or 'search'
    selectedWelcomeItem: 0,
    selectedSuggestionItem: 0,
    
    next(container) {
      // Handle search results navigation when query is present
      if (this.query.length > 0) {
        const curIdx = this.flat.findIndex(f => f.file_path === this.selected.file_path);
        let nextIdx = curIdx + 1;
        if(nextIdx >= this.flat.length) {
          nextIdx = 0;
        }
        this.selected = this.flat[nextIdx];
        const selector = `a[data-searchid='${this.selected.file_path}']`;
        const a = $refs.searchContainer.querySelector(selector);
        if (a) a.scrollIntoView({ block: 'nearest', behavior: 'instant'});
        this.selectedSection = 'search';
        return;
      }
      
      // Handle navigation between sections
      if (this.selectedSection === 'recents') {
        if (this.recentPages.length === 0) {
          // No recents, move to welcome section
          this.selectedSection = 'welcome';
          this.selectedWelcomeItem = 0;
          this.selectWelcomeItem(0);
          return;
        }
        
        const curIdx = this.recentPages.findIndex(p => p === this.selectedRecent);
        let nextIdx = curIdx + 1;
        if (nextIdx >= this.recentPages.length) {
          // Move to welcome section
          this.selectedSection = 'welcome';
          this.selectedWelcomeItem = 0;
          this.selectWelcomeItem(0);
          return;
        }
        
        // Next recent item
        this.selectedRecent = this.recentPages[nextIdx];
        const selector = `div[data-recent-id='${nextIdx}']`;
        const div = $refs.searchContainer.querySelector(selector);
        if (div) div.scrollIntoView({ block: 'nearest', behavior: 'instant'});
      } 
      else if (this.selectedSection === 'welcome') {
        let nextIdx = this.selectedWelcomeItem + 1;
        if (nextIdx >= 2) { // 2 welcome items
          // Move to suggestions section
          this.selectedSection = 'suggestions';
          this.selectedSuggestionItem = 0;
          this.selectSuggestionItem(0);
          return;
        }
        
        // Next welcome item
        this.selectWelcomeItem(nextIdx);
      } 
      else if (this.selectedSection === 'suggestions') {
        // Only one suggestion item, go back to recents
        if (this.recentPages.length > 0) {
          this.selectedSection = 'recents';
          this.selectedRecent = this.recentPages[0];
          const selector = `div[data-recent-id='0']`;
          const div = $refs.searchContainer.querySelector(selector);
          if (div) div.scrollIntoView({ block: 'nearest', behavior: 'instant'});
        } else {
          // No recents, go to welcome
          this.selectedSection = 'welcome';
          this.selectedWelcomeItem = 0;
          this.selectWelcomeItem(0);
        }
      }
    }, 
    
    prev(container) {
      // Handle search results navigation when query is present
      if (this.query.length > 0) {
        const curIdx = this.flat.findIndex(f => f.file_path === this.selected.file_path);
        let prevIdx = curIdx - 1;
        if(prevIdx < 0) {
          prevIdx = this.flat.length - 1;
        }
        this.selected = this.flat[prevIdx];
        const selector = `a[data-searchid='${this.selected.file_path}']`;
        const a = $refs.searchContainer.querySelector(selector);
        if (a) a.scrollIntoView({ block: 'nearest', behavior: 'instant'});
        this.selectedSection = 'search';
        return;
      }
      
      // Handle navigation between sections
      if (this.selectedSection === 'recents') {
        if (this.recentPages.length === 0) {
          // No recents, move to suggestions
          this.selectedSection = 'suggestions';
          this.selectedSuggestionItem = 0;
          this.selectSuggestionItem(0);
          return;
        }
        
        const curIdx = this.recentPages.findIndex(p => p === this.selectedRecent);
        let prevIdx = curIdx - 1;
        if (prevIdx < 0) {
          // Move to suggestions section
          this.selectedSection = 'suggestions';
          this.selectedSuggestionItem = 0;
          this.selectSuggestionItem(0);
          return;
        }
        
        // Previous recent item
        this.selectedRecent = this.recentPages[prevIdx];
        const selector = `div[data-recent-id='${prevIdx}']`;
        const div = $refs.searchContainer.querySelector(selector);
        if (div) div.scrollIntoView({ block: 'nearest', behavior: 'instant'});
      } 
      else if (this.selectedSection === 'welcome') {
        let prevIdx = this.selectedWelcomeItem - 1;
        if (prevIdx < 0) {
          // Move to recents section if available
          if (this.recentPages.length > 0) {
            this.selectedSection = 'recents';
            this.selectedRecent = this.recentPages[this.recentPages.length - 1];
            const selector = `div[data-recent-id='${this.recentPages.length - 1}']`;
            const div = $refs.searchContainer.querySelector(selector);
            if (div) div.scrollIntoView({ block: 'nearest', behavior: 'instant'});
          } else {
            // No recents, wrap to suggestions
            this.selectedSection = 'suggestions';
            this.selectedSuggestionItem = 0;
            this.selectSuggestionItem(0);
          }
          return;
        }
        
        // Previous welcome item
        this.selectWelcomeItem(prevIdx);
      } 
      else if (this.selectedSection === 'suggestions') {
        // Move to welcome section
        this.selectedSection = 'welcome';
        this.selectedWelcomeItem = 1; // Last welcome item
        this.selectWelcomeItem(1);
      }
    },
    
    // Helper methods for selection
    selectWelcomeItem(index) {
      // Update state
      this.selectedSection = 'welcome';
      this.selectedWelcomeItem = index;
      
      // Clear all selections
      this.clearAllSelections();
      
      // Apply new selection
      const welcomeItems = $refs.searchContainer.querySelectorAll('[data-welcome-id]');
      if (welcomeItems && welcomeItems[index]) {
        welcomeItems[index].classList.add('cmd-recent-selected');
        welcomeItems[index].scrollIntoView({ block: 'nearest', behavior: 'instant'});
      }
    },
    
    selectSuggestionItem(index) {
      // Update state
      this.selectedSection = 'suggestions';
      this.selectedSuggestionItem = index;
      
      // Clear all selections
      this.clearAllSelections();
      
      // Apply new selection
      const suggestionItem = $refs.searchContainer.querySelector('[data-suggestion-id]');
      if (suggestionItem) {
        suggestionItem.classList.add('cmd-recent-selected');
        suggestionItem.scrollIntoView({ block: 'nearest', behavior: 'instant'});
      }
    },
    
    clearAllSelections() {
      // Clear all selected items
      const allItems = $refs.searchContainer.querySelectorAll('.cmd-recent-selected');
      allItems.forEach(item => {
        item.classList.remove('cmd-recent-selected');
      });
    },
    
    set(file) {
      this.selected = file;
      this.selectedSection = 'search';
      this.clearAllSelections();
    },
    
    setRecent(page, index) {
      this.selectedRecent = page;
      this.selectedSection = 'recents';
    },
    
    goto() {
      if (this.query.length > 0) {
        // Handle search results
        if (!this.selected.file_path) {
          return;
        }
        window.location.pathname = this.selected.file_path
          .slice(0, -3)
          .replaceAll('&', '')
          .replaceAll('¬∂', '')
          .replaceAll('¬ß', '')
          .toLowerCase()
          .replaceAll(' ', '-')
          .replaceAll('.md', '')
          .replaceAll('/_index', '')
          .replace(/\/+/g, '/')
          .split('/')
          .map(segment => segment.replace(/^-+|-+$/g, ''))
          .join('/');
        return;
      }
      
      // Handle navigation based on selected section
      if (this.selectedSection === 'recents') {
        if (this.selectedRecent) {
          window.location.pathname = this.selectedRecent.path;
        }
      } 
      else if (this.selectedSection === 'welcome') {
        if (this.selectedWelcomeItem === 0) {
          // What's been hot lately
          window.location = '/';
        } else {
          // Check pinned note
          const pinnedPosts = {{ $pinned | jsonify }};
          if (pinnedPosts && pinnedPosts.length > 0) {
            window.location = pinnedPosts[0].url;
          } else {
            window.location = '/';
          }
        }
      } 
      else if (this.selectedSection === 'suggestions') {
        // Copy memo content
        const content = document.querySelector('.memo-content')?.textContent || 'No content found';
        navigator.clipboard.writeText(content);
        const notification = document.createElement('div');
        notification.textContent = 'Content copied to clipboard!';
        notification.style.position = 'fixed';
        notification.style.bottom = '20px';
        notification.style.left = '50%';
        notification.style.transform = 'translateX(-50%)';
        notification.style.padding = '10px 20px';
        notification.style.backgroundColor = 'var(--primary-color)';
        notification.style.color = 'white';
        notification.style.borderRadius = '5px';
        notification.style.zIndex = '1000';
        document.body.appendChild(notification);
        setTimeout(() => {
          notification.style.opacity = '0';
          notification.style.transition = 'opacity 0.5s ease';
          setTimeout(() => document.body.removeChild(notification), 500);
        }, 2000);
      }
      this.close();
    },
    
    close() {
      this.searchBar = false;
      this.query = '';
      // Remove class from body
      document.body.classList.remove('cmd-palette-open');
    },
    
    openPalette() {
      this.searchBar = true;
      // Add class to body to help style neko images
      document.body.classList.add('cmd-palette-open');
      // Dispatch event to load recent pages
      const evt = new CustomEvent('command-palette-opened');
      document.dispatchEvent(evt);
      // Reset search
      this.query = '';
      // Set initial selection 
      if (this.recentPages.length > 0) {
        this.selectedRecent = this.recentPages[0];
        this.selectedSection = 'recents';
      } else {
        this.selectedSection = 'welcome';
        this.selectedWelcomeItem = 0;
      }
      this.$nextTick(() => {
        this.$refs.searchInput.focus();
        // Apply initial selection styling
        if (this.selectedSection === 'welcome') {
          this.selectWelcomeItem(this.selectedWelcomeItem);
        } else if (this.selectedSection === 'recents') {
          const selector = `div[data-recent-id='0']`;
          const div = this.$refs.searchContainer.querySelector(selector);
          if (div) div.classList.add('cmd-recent-selected');
        }
      });
    }
  }" 
  class="cmd-palette" 
  @command-palette-recents.window="recentPages = $event.detail.data; if(recentPages.length > 0) { selectedRecent = recentPages[0]; selectedSection = 'recents'; }"
>
  <button class="cmd-search-button" @click="openPalette()">
    <span class="cmd-search-button-text">üîç Search</span>
    <span class="cmd-search-button-keys">
      <kbd class="memo-tag">‚åò</kbd>
      <kbd class="memo-tag">K</kbd>
    </span>
  </button>

  <div 
    @keydown.enter.stop.document="goto()" 
    @keydown.ctrl.j.prevent.document="next()"
    @keydown.ctrl.k.prevent.document="prev()" 
    @keydown.arrow-down.prevent.document="next()" 
    @keydown.arrow-up.prevent.document="prev()"
    class="cmd-overlay" :class="searchBar ?'cmd-modal-active' : 'cmd-modal-hidden'" x-ref="searchContainer">
    <div class="cmd-modal" @mousedown.outside="close()" x-trap.inert.noscroll.noreturn="searchBar">
      <input type="text" x-model="query" :placeholder="searchPlaceholder" autocomplete="off" class="cmd-search-input"
        x-ref="searchInput" 
        @input="
          searching = true; 
          if(query.length === 0) {
            if(recentPages.length > 0) {
              selectedRecent = recentPages[0];
              selectedSection = 'recents';
            } else {
              selectedSection = 'welcome';
              selectedWelcomeItem = 0;
            }
            clearAllSelections();
          } else {
            selectedSection = 'search';
          }
        "
        @input.debounce.750ms="$dispatch('command-palette-search', { data: $event.target.value })"
        @command-palette-search-result.window="
          searching = false; 
          searchResults = $event.detail.data.grouped; 
          flat = $event.detail.data.flat; 
          if(query.length > 0 && flat.length > 0) { 
            selected = flat[0]; 
            selectedSection = 'search';
            clearAllSelections();
          } else if (query.length === 0) {
            if (recentPages.length > 0) { 
              selectedRecent = recentPages[0]; 
              selectedSection = 'recents';
            } else {
              selectedSection = 'welcome';
              selectedWelcomeItem = 0; 
            }
            clearAllSelections();
          }
        "
        @command-palette-search-initialize.window="searchPlaceholder = $event.detail.text"/>
      <div x-cloak :class="searchBar ?'cmd-results-active' : 'cmd-results-hidden'" class="cmd-results"
        @keydown.meta.k.prevent.document="searchBar ? close() : openPalette()"
        @keydown.escape.document="close()">
        <div
          :class="Object.keys(searchResults).length !== 0 && query.length !== 0 ? 'cmd-results-list-wrapper' : 'cmd-results-hidden'">
          <ul class="cmd-results-list" x-ref="resultsList">
            <template x-for="group in Object.entries(searchResults)" :key="group[0]">
              <div class="cmd-results-group">
                <span x-text="group[0]"></span>
                <template x-for="result in group[1]" :key="result.file_path">
                  <li @mouseenter="set(result)"
                    :class="{ 'cmd-result-item': true, 'cmd-result-selected': result.file_path.toLowerCase() === selected?.file_path.toLowerCase() && selectedSection === 'search' }">
                    <a :data-searchid="result.file_path"
                      :href="`/${result.file_path
                        .replaceAll('&', '')
                        .replaceAll('¬∂', '')
                        .replaceAll('¬ß', '')
                        .toLowerCase()
                        .replaceAll(' ', '-')
                        .replaceAll('.md', '')
                        .replaceAll('/_index', '')
                        .replace(/\/+/g, '/')
                        .split('/')
                        .map(segment => segment.replace(/^-+|-+$/g, ''))
                        .join('/')}/`"
                      >
                      <div class="cmd-result-title" x-text="result.title"></div>
                      <p class="cmd-matching-line" x-html="result.matchingLines"></p>
                    </a>
                  </li>
                </template>
              </div>
            </template>
          </ul>
          <template x-if="Object.keys(searchResults).length > 0 && query.length > 0">
            <div class="cmd-result-preview">
              <div class="cmd-preview-icon">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                  <g fill="currentColor">
                    <path fill-rule="evenodd"
                      d="M4.125 3C3.089 3 2.25 3.84 2.25 4.875V18a3 3 0 0 0 3 3h15a3 3 0 0 1-3-3V4.875C17.25 3.839 16.41 3 15.375 3zM12 9.75a.75.75 0 0 0 0 1.5h1.5a.75.75 0 0 0 0-1.5zm-.75-2.25a.75.75 0 0 1 .75-.75h1.5a.75.75 0 0 1 0 1.5H12a.75.75 0 0 1-.75-.75M6 12.75a.75.75 0 0 0 0 1.5h7.5a.75.75 0 0 0 0-1.5zm-.75 3.75a.75.75 0 0 1 .75-.75h7.5a.75.75 0 0 1 0 1.5H6a.75.75 0 0 1-.75-.75M6 6.75a.75.75 0 0 0-.75.75v3c0 .414.336.75.75.75h3a.75.75 0 0 0 .75-.75v-3A.75.75 0 0 0 9 6.75z"
                      clip-rule="evenodd" />
                    <path d="M18.75 6.75h1.875c.621 0 1.125.504 1.125 1.125V18a1.5 1.5 0 0 1-3 0z" />
                  </g>
                </svg>
              </div>
              <span class="cmd-preview-path" x-text="selected?.category"></span>
              <p class="cmd-preview-title" x-text="selected?.title"></p>
              <p class="cmd-preview-description" x-text="selected?.description"></p>
              <div class="cmd-preview-recap">
                <span>on this page</span>
                <p x-html="selected?.spr_content">
              </div>
            </div>
        </div>
        </template>
      </div>

      <!-- Recents Section -->
      <template x-if="!searching && query.length === 0 && recentPages.length > 0">
        <div class="cmd-recents-section">
          <div class="cmd-recents-header">
            <span class="cmd-recents-title">Recents</span>
          </div>
          <ul class="cmd-recents-list">
            <template x-for="(page, index) in recentPages" :key="index">
              <div 
                class="cmd-recent-item" 
                :class="{ 'cmd-recent-selected': page === selectedRecent && selectedSection === 'recents' }"
                @mouseenter="setRecent(page, index); clearAllSelections()"
                @click="goto()"
                :data-recent-id="index"
              >
                <svg class="cmd-recent-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path>
                  <polyline points="14 2 14 8 20 8"></polyline>
                </svg>
                <span class="cmd-recent-title" x-text="page.title"></span>
              </div>
            </template>
          </ul>
        </div>
      </template>
      
      <!-- Welcome to Dwarves Memo Section -->
      <template x-if="!searching && query.length === 0">
        <div class="cmd-recents-section">
          <div class="cmd-recents-header">
            <span class="cmd-recents-title">Welcome to Dwarves Memo</span>
          </div>
          <ul class="cmd-recents-list">
            <div 
              class="cmd-recent-item"
              :class="{ 'cmd-recent-selected': selectedSection === 'welcome' && selectedWelcomeItem === 0 }"
              @click="window.location = '/'; close();"
              @mouseenter="selectWelcomeItem(0)"
              data-welcome-id="0"
            >
              <svg class="cmd-recent-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path>
                <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path>
              </svg>
              <span class="cmd-recent-title">What's been hot lately</span>
            </div>
            <div 
              class="cmd-recent-item"
              :class="{ 'cmd-recent-selected': selectedSection === 'welcome' && selectedWelcomeItem === 1 }"
              x-data="{ 
                pinnedPosts: {{ $pinned | jsonify }},
                getPinnedUrl() {
                  if (this.pinnedPosts && this.pinnedPosts.length > 0) {
                    return this.pinnedPosts[0].url;
                  }
                  return '/';
                }
              }"
              @click="window.location = getPinnedUrl(); close();"
              @mouseenter="selectWelcomeItem(1)"
              data-welcome-id="1"
            >
              <svg class="cmd-recent-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M12 1L1 8l11 7 11-7-11-7M2 19v-8.4L12 17l10-6.4V19l-10 7-10-7z"></path>
              </svg>
              <span class="cmd-recent-title">Check pinned note</span>
            </div>
          </ul>
        </div>
      </template>
      
      <!-- Suggestions Section -->
      <template x-if="!searching && query.length === 0">
        <div class="cmd-recents-section">
          <div class="cmd-recents-header">
            <span class="cmd-recents-title">Suggestions</span>
          </div>
          <ul class="cmd-recents-list">
            <div 
              class="cmd-recent-item"
              :class="{ 'cmd-recent-selected': selectedSection === 'suggestions' && selectedSuggestionItem === 0 }"
              @click="
                const content = document.querySelector('.memo-content')?.textContent || 'No content found';
                navigator.clipboard.writeText(content);
                const notification = document.createElement('div');
                notification.textContent = 'Content copied to clipboard!';
                notification.style.position = 'fixed';
                notification.style.bottom = '20px';
                notification.style.left = '50%';
                notification.style.transform = 'translateX(-50%)';
                notification.style.padding = '10px 20px';
                notification.style.backgroundColor = 'var(--primary-color)';
                notification.style.color = 'white';
                notification.style.borderRadius = '5px';
                notification.style.zIndex = '1000';
                document.body.appendChild(notification);
                setTimeout(() => {
                  notification.style.opacity = '0';
                  notification.style.transition = 'opacity 0.5s ease';
                  setTimeout(() => document.body.removeChild(notification), 500);
                }, 2000);
                close();
              "
              @mouseenter="selectSuggestionItem(0)"
              data-suggestion-id="0"
            >
              <svg class="cmd-recent-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path>
                <rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect>
              </svg>
              <span class="cmd-recent-title">Copy memo</span>
            </div>
          </ul>
        </div>
      </template>

      <!-- No Results -->
      <template x-if="!searching && Object.keys(searchResults).length === 0 && query.length > 0">
        <div class="cmd-no-results">
          <img src="{{ $img.RelPermalink }}" />
        </div>
      </template>
      
      <div class="cmd-instructions">
        Type <kdb class="memo-tag">ESC</kdb> to close search bar
      </div>
    </div>
  </div>
</div>
</div>
