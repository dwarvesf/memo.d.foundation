# This file will be included by the main nginx.conf or replace it.
# It assumes nginx_redirect_map.conf is in the same directory or a known path.

# Increase the hash bucket size for larger maps
# This is necessary if you have a large number of redirects.
# Current implementation capability for 100k lines.
map_hash_bucket_size 256;
map_hash_max_size 131072;

# Include the generated redirect map
# The path might need adjustment based on where it's copied in the Docker image.
# For now, assuming it's in /etc/nginx/conf.d/ or similar.
# We will copy nginx_redirect_map.conf to /etc/nginx/conf.d/ in the Dockerfile.
include /etc/nginx/conf.d/nginx_redirect_map.conf;

server {
    listen 80;
    server_name localhost; # Adjust as necessary

    # Root directory for your static Next.js export
    root /usr/share/nginx/html;
    index index.html index.htm;

    location / {
        # Check if the requested URI has a redirect target in our map
        if ($redirect_target != 0) {
            return 301 $redirect_target$is_args$args;
        }

        # If no redirect, try to serve the file according to Next.js SSG structure
        # 1. Try direct file match (for assets like .css, .js, images)
        # 2. Try URI with .html appended (for pages like /about -> /about.html)
        # 3. Try URI as a directory with index.html (for /path -> /path/index.html)
        # 4. Fallback to 404 page
        try_files $uri $uri.html ${uri}/index.html /404.html;
    }

    # Standard error pages
    error_page 404 /404.html;
    location = /404.html {
        root /usr/share/nginx/html; # Ensure Nginx can find 404.html
        internal;
    }

    # You might not have a generic 50x.html with Next.js SSG.
    # Nginx's default 50x page will be used if not specified and present.
    # If you have a custom 50x.html, uncomment and adjust:
    # error_page 500 502 503 504 /50x.html;
    # location = /50x.html {
    #     root /usr/share/nginx/html;
    #     internal;
    # }

    # Deny access to hidden files
    location ~ /\. {
        deny all;
    }

    # Add any other specific Nginx configurations you need
    # For example, gzip compression, cache control headers, etc.
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types text/plain text/css application/json application/javascript application/x-javascript text/xml application/xml application/xml+rss text/javascript image/svg+xml;
}
