<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content><meta name=keywords content><meta name=title content><meta name=description content><meta property="og:title" content><meta property="og:description" content><meta property="og:type" content="article"><meta property="og:url" content="https://note.d.foundation/playbook/engineering/blockchain/precautions/"><meta property="og:image" content="https://note.d.foundation/img/LOGO.png"><meta property="twitter:title" content><meta property="twitter:description" content><meta property="twitter:type" content="article"><meta property="twitter:url" content="https://note.d.foundation/playbook/engineering/blockchain/precautions/"><meta property="twitter:image" content="https://note.d.foundation/img/LOGO.png"><link rel=icon type=image/x-icon href=https://note.d.foundation/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://note.d.foundation/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://note.d.foundation/favicon-32x32.png><link rel=apple-touch-icon href=https://note.d.foundation/apple-touch-icon.png><title></title>
<link rel=canonical href=https://note.d.foundation/playbook/engineering/blockchain/precautions/><link rel="shortcut icon" type=image/png href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNk+A8AAQUBAScY42YAAAAASUVORK5CYII="><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/prism-themes/1.9.0/prism-vs.min.css integrity="sha512-Jn4HzkCnzA7Bc+lbSQHAMeen0EhSTy71o9yJbXZtQx9VvozKVBV/2zfR3VyuDFIxGvHgbOMMNvb80l+jxFBC1Q==" crossorigin=anonymous referrerpolicy=no-referrer media="(prefers-color-scheme: dark)"><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/prism-themes/1.9.0/prism-vsc-dark-plus.min.css integrity="sha512-ML8rkwYTFNcblPFx+VLgFIT2boa6f8DDP6p6go4+FT0/mJ8DCbCgi6S0UdjtzB3hKCr1zhU+YVB0AHhIloZP8Q==" crossorigin=anonymous referrerpolicy=no-referrer media="(prefers-color-scheme: light)"><script defer data-domain=note.d.foundation src=https://plausible.io/js/script.js></script><script defer src=https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js></script><link rel=preconnect href=https://B0BWKXLVM9-dsn.algolia.net crossorigin><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@docsearch/css@3><script src=https://cdn.jsdelivr.net/npm/@docsearch/js@3></script><style>body{font-family:ibm plex sans,sans-serif;font-size:1rem;color:#000;text-rendering:optimizeLegibility;padding:2rem;max-width:100%;margin:0;padding:0;background-color:var(--primary-background-color-light);line-height:1.5;min-height:100vh;display:flex;flex-direction:column;hyphens:auto}h1,h2,h3,h4{color:var(--primary-font-color);line-height:1.24}h1{font-size:32pt}h2{font-size:24pt}h3{font-size:16pt}h4{font-size:12pt}a[href^="#"]{text-decoration:none}time{padding-right:1rem}blockquote{margin:1em 0;padding:0 2em;border-left:3px solid #eee}img{max-width:100%}video{max-width:100%}a,a:visited{color:#000}q{font-size:20px;max-width:500px;display:block;margin-left:30px}pre{font-family:monospace!important;background:#000!important;color:#dadada;padding:4px!important;margin:0!important;border-radius:2px;overflow-x:auto;width:100%;max-width:100vw!important;box-sizing:border-box;background-clip:padding-box}pre>code{text-indent:0;white-space:inherit;font-weight:400;padding:15px!important;box-sizing:border-box;background-clip:padding-box}code{line-height:1.5!important;font-family:monospace!important;font-size:12px!important;background:#333!important;color:#dadada;padding:2px 5px;white-space:wrap;border-radius:2px;font-weight:700;display:inline-block;margin-bottom:-4px;box-sizing:border-box;background-clip:padding-box}code comment{color:#777}table code{margin:0;background:var(--secondary-background-color-light)!important;color:var(--secondary-font-color-light);border:.5px solid var(--secondary-font-color-light)}span a,span a:visited{color:inherit}[style*="color:yellow"]{color:gold!important}[style*="color:blue"]{color:#6495ed!important}[style*="color:red"]{color:crimson!important}@media(prefers-color-scheme:dark){a,a:visited{color:#dadada}pre{font-family:monospace!important;background:#fff!important;color:var(--primary-background-color)}code{font-family:monospace!important;background:#ddd!important;color:var(--primary-background-color)}table code{background:var(--secondary-background-color)!important;color:var(--secondary-font-color)}}iframe{box-sizing:border-box;max-width:100%}@media(prefers-color-scheme:light){h1,h2,h3,h4{color:var(--primary-font-color-light)}}@media screen and (max-width:1100px){h1{font-size:calc(1.45rem + 2vw)}h2{font-size:calc(1rem + 1.5vw)}h3{font-size:calc(1rem + 1vw)}h4{font-size:calc(1rem + .5vw)}}:root{--primary-color:#e13F5e;--docsearch-primary-color:#e13F5e;--docsearch-primary-color:#e13F5e;--primary-font-color:#ddd;--primary-font-color-light:#333;--secondary-font-color:#e8e8e8;--secondary-font-color-light:#717171;--primary-background-color:#1e1e1e;--primary-background-color-light:#fff;--secondary-background-color:#282828;--secondary-background-color-light:#f6f6f6;--border-color:#3d3d3d;--border-color-light:#e7e7e7;--container-max-width:1240px;--main-padding:36px;--column-gap:24px;--nav-sidebar-width:200px;--nav-sidebar-offset:0px}.grid .title{grid-area:title;margin:32px 0 0!important;color:var(--primary-color)}.grid .subtitle{grid-area:subtitle;font-size:18px;padding-top:16px;padding-bottom:32px}.grid #docsearch{grid-area:docsearch}.grid #docsearch>button{width:90%;height:75%;border-radius:0}.grid #docsearch>button>span{padding-left:12px;font-family:ibm plex sans,sans-serif}.DocSearch-Footer{box-shadow:none}.active{color:var(--primary-color);line-height:1;border-bottom:2px solid var(--primary-color);padding-top:4px!important}nav.tab-menu{grid-area:tabmenu;border-bottom:1px solid var(--border-color-light);padding-bottom:0;overflow:auto}nav.tab-menu ul{list-style-type:none;padding:0;margin-bottom:0;display:inline-grid;grid-auto-flow:column;grid-template-rows:1fr;grid-template-columns:repeat(auto-fit,minmax(min-content,1fr));column-gap:48px}nav.tab-menu ul li{font-size:16px;font-weight:500;display:inline-block;padding:0 0 16px;width:min-content}nav.tab-menu ul li a{text-decoration:none;color:inherit}nav.tab-menu ul li a:hover{background-color:var(--primary-background-color);padding:0}nav.tab-menu ul li:last-of-type{margin-right:30px!important}@media(prefers-color-scheme:dark){nav.tab-menu{border-bottom:1px solid var(--border-color)}}@media only screen and (max-width:1100px){.DocSearch{width:100%!important;height:50px!important;padding:0;margin:0}}nav.menu{padding:calc(var(--main-padding) - 12px)var(--main-padding);line-height:22px;white-space:nowrap;grid-area:nav}details{margin-left:-7px;overflow:hidden;font-size:14px}summary{display:block;padding:5px 5px 12px 20px;position:relative;cursor:pointer;font-size:20px;font-weight:600;text-transform:capitalize;user-select:none}nav section details:not(:last-of-type) ul{margin-bottom:24px}summary:before{content:'\25B8';position:absolute;top:7px;left:0;transform:rotate(0);transform-origin:50% 50%;transition:.25s transform ease;font-size:16px;height:16px;width:16px;font-weight:200;display:flex;justify-content:center;align-items:center}summary:before>*{height:4px;width:4px}details[open]>summary:before{transform:rotate(90deg)}details summary::-webkit-details-marker{display:none}details>ul{margin-bottom:0}hr{margin:20px 0!important;width:100%;max-width:inherit;border-color:var(--secondary-background-color-light)}nav.menu{background-color:var(--secondary-background-color-light)}nav .site-nav{display:inline-block;width:100%}nav .site-nav section{margin-top:-2px}nav .site-nav section h2{margin:20px 0;font-size:24px;text-transform:lowercase}nav.menu ul{display:inline-grid;grid-template-rows:repeat(auto-fill,minmax(0,1fr));grid-template-columns:repeat(auto-fill,minmax(var(--nav-sidebar-width),1fr));padding:0 10px 10px 0;margin:0;list-style-type:none;line-height:22px;box-sizing:border-box}nav .site-nav ul li{list-style-type:none;display:flex;font-variant-numeric:tabular-nums;font-size:14px;padding-left:20px;max-width:fit-content}nav .site-nav ul li a{padding:0 4px}.load-more{font-style:italic;padding-top:8px;color:var(--primary-color)!important;cursor:pointer}@media(prefers-color-scheme:dark){nav.menu{background-color:var(--secondary-background-color)}hr{border-color:var(--secondary-background-color)}}@media only screen and (max-width:1100px){nav.menu{padding:4.5%}nav.menu ul{width:100%;row-gap:4px;column-gap:4px}nav .site-nav section{margin:0 10px 10px 0}nav.menu{max-width:100%;box-sizing:border-box;display:inline-block}}footer{padding:var(--main-padding);clear:both;border-top:1px solid var(--border-color-light)}footer span{color:var(--secondary-font-color-light)}@media(prefers-color-scheme:dark){footer{border-top:1px solid var(--border-color)}footer span{color:var(--secondary-font-color)}}.note-title{display:inline-grid;width:100%;row-gap:12px;margin:0;grid-template-areas:"pagetitle pagetitle" "date tags" "authors tags";grid-template-rows:repeat(auto-fill,minmax(0,1fr));grid-template-columns:repeat(2,1fr)}.note-title .pagetitle{grid-area:pagetitle;margin:0}.note-title .date{grid-area:date;color:#636466}.note-title .tags{display:inline-flex;flex-wrap:wrap;gap:6px;grid-area:tags;justify-self:right;justify-content:right}.note-title .tags .tag{padding:1px 6px;border-radius:4px;background-color:var(--secondary-background-color-light);height:fit-content;text-decoration:none;color:var(--secondary-font-color-light)}.note-title .authors{grid-area:authors}.clear-title{grid-template-areas:"pagetitle pagetitle";gap:0}.clear-title .date{display:none}.clear-title .tags{display:none}.clear-title .authors{display:none}code.button{background:var(--primary-background-color-light);color:#000;font-size:smaller;display:inline-block;padding:0 6px;font-weight:700;border-radius:2px;line-height:22px}.grid{display:inline-grid;grid-template-areas:"title title title title" "subtitle subtitle docsearch docsearch" "tabmenu tabmenu tabmenu tabmenu" "nav content content pagenav" "nav content content pagenav";grid-template-rows:repeat(auto-fill,minmax(0,1fr));grid-template-columns:325px 2fr 2fr 1fr;column-gap:var(--column-gap)}.grid>*{padding-right:calc(var(--main-padding) - 12px);padding-left:calc(var(--main-padding) + 12px)}#docsearch{grid-area:docsearch}main{grid-area:content;display:inline-block;padding:var(--main-padding);width:calc(100vw - 325px - 72px);max-width:var(--container-max-width);box-sizing:border-box;overflow-wrap:break-word;hyphens:none;justify-self:left}main ul{line-height:25px;margin:0;padding:0;padding-inline-start:40px}main ul>li>a{text-decoration:underline}.scrollable{overflow:auto}.dual-list>ul{columns:2}.single-list>ul{columns:2}.profile img{width:100px;height:100px;object-fit:cover;aspect-ratio:1/1}.profile object{width:100px;height:100px;object-fit:cover;aspect-ratio:1/1}table,th,td{border:1px solid;border-collapse:collapse;border-spacing:0;border-color:var(--border-color-light)}thead *{padding:6px 12px;background-color:var(--secondary-background-color-light)}th,td{padding:6px 12px;overflow:hidden;text-overflow:ellipsis;vertical-align:top;text-align:left}td:has(img){padding:12px;line-height:0}table{table-layout:fixed}table:has(th:empty){border:none}table:has(th:empty) th{border:none;padding:0;line-height:0}table:has(th:empty) td{border:none}table:has(img){width:100%;height:100%}table:has(img) td{min-width:200px}table:has(img) img{width:100%!important;height:100%!important;object-fit:cover}#TableOfContents>ul>li>a{text-decoration:underline}#TableOfContents>ul{display:grid;column-gap:var(--column-gap);box-sizing:border-box;grid-template-columns:repeat(auto-fill,minmax(0,calc(50% - var(--column-gap))));line-height:20px}#TableOfContents li{white-space:nowrap;list-style-type:decimal-leading-zero;list-style-position:inside;overflow:hidden;text-overflow:ellipsis}.notice{padding:20px;border:2px solid #000;margin-bottom:16px}main>blockquote{padding:20px;border:2px solid #000}main>*{max-width:inherit}li:has(input[type=checkbox]){display:block;list-style-type:none}ul:has(li input[type=checkbox]){padding:0}ul li a{overflow:hidden;text-overflow:ellipsis;white-space:wrap;text-decoration:none;transition:all .25s ease}ul li a:hover{background-color:var(--primary-color);color:#fff;padding-left:4px;padding-right:4px;border-radius:4px;width:100%;z-index:10}ul li p{margin-block-end:0;margin-block-start:0}@media(prefers-color-scheme:dark){html[data-theme=dark]{--docsearch-searchbox-background:var(--secondary-background-color);--docsearch-modal-background:var(--secondary-background-color);--docsearch-footer-background:var(--secondary-background-color);--docsearch-key-gradient:linear-gradient(-26.5deg, #555, var(--secondary-background-color));--docsearch-muted-color:#777;--docsearch-key-shadow:inset 0 -2px 0 0 var(--secondary-background-color),inset 0 0 1px 1px #555,0 2px 2px 0 rgba(3,4,9,0.3)}body{background:var(--primary-background-color);color:#dadada}body select{color:#000;background-color:#fff}.project{border-left:2px solid #fff}.notice{border-color:#fff}.mono{filter:invert(1)}.progress>div{background-color:#fff}.progress>div>span{color:#000}main>blockquote{border-color:#fff}ul li a{background-color:inherit}section>ul li a{background-color:inherit}.note-title .tags .tag{background-color:var(--secondary-background-color);color:var(--secondary-font-color)}table,th,td{border-color:var(--border-color)}thead *{background-color:var(--secondary-background-color)}}@media only screen and (max-width:1100px){.grid{display:inline-grid;grid-template-areas:"title" "subtitle" "docsearch" "tabmenu" "content" "nav" "pagenav";grid-template-rows:repeat(auto-fill,minmax(0,1fr));grid-template-columns:1fr}.grid>*{padding-right:4.5%;padding-left:4.5%}.note-title{width:100%;grid-template-areas:"pagetitle" "date" "tags" "authors";grid-template-rows:repeat(auto-fill,minmax(0,1fr));grid-template-columns:1fr}.note-title .tags{max-width:max-content;justify-self:left;justify-content:flex-start}main{justify-self:center;width:100%;max-width:700px}}.col-2{display:inline-grid;column-gap:36px;padding-bottom:36px;grid-template-columns:repeat(auto-fit,minmax(20%,1fr))}.col-2>*{overflow-wrap:break-word;overflow:auto}</style><script defer src=/js/process-comments.js></script><script defer src=/js/tab-menu.js></script><script defer src=/js/markdown-entities.js></script><script defer src=/js/algolia.js></script><script defer src=/js/dark-light-check.js></script><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","articleSection":"playbook","name":"","headline":"","alternativeHeadline":"","description":"As we discussed in the General Philosophy section, it is not enough to protect yourself against the known attacks. Since the cost of failure on a blockchain can be very high, you must also adapt the way you write software, to account for that risk.\nThe approach we advocate is to \u0026ldquo;prepare for failure\u0026rdquo;. It is impossible to know in advance whether your code is secure. However, you can architect your contracts in a way that allows them to fail gracefully, and with minimal damage.","inLanguage":"en-us","isFamilyFriendly":"true","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/note.d.foundation\/playbook\/engineering\/blockchain\/precautions\/"},"author":{"@type":"Person","name":"Han Ngo"},"creator":{"@type":"Person","name":"Han Ngo"},"accountablePerson":{"@type":"Person","name":"Han Ngo"},"copyrightHolder":"Dwarves Foundation","copyrightYear":"0001","date":"0001-01-01T00:00:00.00Z","dateCreated":"0001-01-01T00:00:00.00Z","datePublished":"0001-01-01T00:00:00.00Z","dateModified":"0001-01-01T00:00:00.00Z","publisher":{"@type":"Organization","name":"Dwarves Foundation","url":"https://note.d.foundation/","logo":{"@type":"ImageObject","url":"https:\/\/note.d.foundation\/","width":"32","height":"32"}},"image":"https://note.d.foundation/","url":"https:\/\/note.d.foundation\/playbook\/engineering\/blockchain\/precautions\/","wordCount":"2082","genre":[],"keywords":[]}</script><style>body{visibility:hidden;opacity:0}</style><noscript><style>body{visibility:visible;opacity:1}</style></noscript><script type=text/javascript>window.addEventListener("DOMContentLoaded",function(){document.body.style.visibility="visible",document.body.style.opacity=1})</script></head><body><div class=grid><h1 class=title><a style=color:inherit;text-decoration:none href=/site-index>Dwarves Notes</a></h1><div class=subtitle>A collection of notes for everything we do and operate at Dwarves.</div><div id=docsearch></div><nav class=tab-menu x-data="{
    currentUrl: `/playbook/engineering/blockchain/precautions/`,
    links: [
      { title: 'Home', url: '/home/' },
      { title: 'Consulting', url: '/memo/consulting/' },
      { title: 'Labs', url: '/memo/labs' },
      { title: 'Earn', url: '/earn/' },
      { title: 'Hiring', url: '/hiring/' },
      { title: 'Newsletter', url: '/newsletter/' },
      { title: 'Events', url: '/events/' },
    ],
    activeUrl: '',
    isActiveUrl(url) {
      if (!this.activeUrl) {
        this.activeUrl = this.currentUrl.startsWith(url);
        return this.activeUrl;
      }
    },
  }"><ul><template x-for="item in links"><li x-bind:class="{ 'active': isActiveUrl(item.url) }"><a x-bind:href=item.url x-text=item.title></a></li></template></ul></nav><nav class=menu><section class=site-nav x-data="{
      currentUrl: `/playbook/engineering/blockchain/precautions/`,
      get data() {
        const dataString = `[]`;
        const data = JSON.parse(dataString);
        data.sort((a, b) => Date.parse(b.date) - Date.parse(a.date));
        console.log(data);
        return data;
      },
    }"><template x-for="item in data" x-bind:key=item><details x-data="{ start: 0, end: 10, loaded: false, loadText: 'Load more...', }" open><summary>Pinned Notes</summary><ul><li><a x-bind:href=item.url x-text=item.title></a></li></ul></details></template></section></nav><main x-data="{
      currentUrl: `/playbook/engineering/blockchain/precautions/`,
      title: ``,
      get tagsData() {
        const dataString = `[{&#34;tags&#34;:null,&#34;url&#34;:&#34;/playbook/engineering/blockchain/precautions/&#34;}]`;
        const data = JSON.parse(dataString);
        return data;
      },
      isClearPage() {
        const showFrontmatter = (/true/i).test(``);
        return !showFrontmatter || this.currentUrl.includes('home') || this.currentUrl.includes('tags');
      },
      isTagPage() {
        return this.currentUrl.includes('tags');
      }
    }"><template x-if=!!title><div x-bind:class="{ 'note-title': true, 'clear-title': isClearPage() }"><div class=title-index style=display:none></div><div class=tags-index style=display:none>tags:</div><template x-if=isTagPage()><h1 class=pagetitle x-text="`#${title}`"></h1></template><template x-if=!isTagPage()><h1 class=pagetitle x-text=title></h1></template><div class=date>Jan 1, 0001</div><template x-for="data in tagsData"><template x-if="data.tags && data.tags.length > 0"><div class=tags>Tags:
<template x-for="tag in data.tags"><a class=tag x-bind:href="`/tags/${tag.toLowerCase()}`" x-text=tag></a></template></div></template></template></div><hr></template><p>As we discussed in the General Philosophy section, it is not enough to protect yourself against the known attacks. Since the cost of failure on a blockchain can be very high, you must also adapt the way you write software, to account for that risk.</p><p>The approach we advocate is to &ldquo;prepare for failure&rdquo;. It is impossible to know in advance whether your code is secure. However, you can architect your contracts in a way that allows them to fail gracefully, and with minimal damage. This section presents a variety of techniques that will help you prepare for failure.</p><p>Note: There&rsquo;s always a risk when you add a new component to your system. A badly designed fail-safe could itself become a vulnerability - as can the interaction between a number of well-designed fail-safes. Be thoughtful about each technique you use in your contracts, and consider carefully how they work together to create a robust system.</p><h2 id=deployment><a href=#deployment>Deployment <a href=#deployment></a></a></h2><p>Contracts should have a substantial and prolonged testing period - before substantial money is put<br>at risk.</p><p>At minimum, you should:</p><ul><li>Have a full test suite with 100% test coverage (or close to it)</li><li>Deploy on your own testnet</li><li>Deploy on the public testnet with substantial testing and bug bounties</li><li>Exhaustive testing should allow various players to interact with the contract at volume</li><li>Deploy on the mainnet in beta, with limits to the amount at risk</li></ul><h5 id=automatic-deprecation><a href=#automatic-deprecation>Automatic Deprecation <a href=#automatic-deprecation></a></a></h5><p>During testing, you can force an automatic deprecation by preventing any actions, after a certain<br>time period. For example, an alpha contract may work for several weeks and then automatically shut<br>down all actions, except for the final withdrawal.</p><pre><code class=language-sol>modifier isActive() {
    require(block.number &lt;= SOME_BLOCK_NUMBER);
    _;
}

function deposit() public isActive {
    // some code
}

function withdraw() public {
    // some code
}
</code></pre><h5 id=restrict-amount-of-ether-per-usercontract><a href=#restrict-amount-of-ether-per-usercontract>Restrict amount of Ether per user/contract <a href=#restrict-amount-of-ether-per-usercontract></a></a></h5><p>In the early stages, you can restrict the amount of Ether for any user (or for the entire contract)</p><ul><li>reducing the risk.</li></ul><h2 id=circuit-breakers><a href=#circuit-breakers>Circuit breakers <a href=#circuit-breakers></a></a></h2><p>Circuit breakers stop execution if certain conditions are met, and can be useful when new errors<br>are discovered. For example, most actions may be suspended in a contract if a bug is discovered,<br>and the only action now active is a withdrawal. You can either give certain trusted parties the<br>ability to trigger the circuit breaker or else have programmatic rules that automatically trigger<br>the certain breaker when certain conditions are met.</p><p>Example:</p><pre><code class=language-sol>bool private stopped = false;
address private owner;

modifier isAdmin() {
    require(msg.sender == owner);
    _;
}

function toggleContractActive() isAdmin public {
    // You can add an additional modifier that restricts stopping a contract to be based on another action, such as a vote of users
    stopped = !stopped;
}

modifier stopInEmergency { if (!stopped) _; }
modifier onlyInEmergency { if (stopped) _; }

function deposit() stopInEmergency public {
    // some code
}

function withdraw() onlyInEmergency public {
    // some code
}
</code></pre><h2 id=rate-limit><a href=#rate-limit>Rate limit <a href=#rate-limit></a></a></h2><p>Rate limiting halts or requires approval for substantial changes. For example, a depositor may only<br>be allowed to withdraw a certain amount or percentage of total deposits over a certain time period<br>(e.g., max 100 ether over 1 day) - additional withdrawals in that time period may fail or require<br>some sort of special approval. Or the rate limit could be at the contract level, with only a<br>certain amount of tokens issued by the contract over a time period.</p><p>Example:</p><pre><code class=language-sol>uint internal period; // how many blocks before limit resets
uint internal limit; // max ether to withdraw per period
uint internal currentPeriodEnd; // block which the current period ends at
uint internal currentPeriodAmount; // amount already withdrawn this period

constructor(uint _period, uint _limit) public {
    period = _period;
    limit = _limit;

    currentPeriodEnd = block.number + period;
}

function withdraw(uint amount) public {
    // Update period before proceeding
    updatePeriod();

    // Prevent overflow
    uint totalAmount = currentPeriodAmount + amount;
    require(totalAmount &gt;= currentPeriodAmount, 'overflow');

    // Disallow withdraws that exceed current rate limit
    require(currentPeriodAmount + amount &lt; limit, 'exceeds period limit');
    currentPeriodAmount += amount;
    msg.sender.transfer(amount);
}

function updatePeriod() internal {
    if(currentPeriodEnd &lt; block.number) {
        currentPeriodEnd = block.number + period;
        currentPeriodAmount = 0;
    }
}
</code></pre><p>Some tips for running bounty programs:</p><ul><li>Decide which currency bounties will be distributed in (BTC and/or ETH)</li><li>Decide on an estimated total budget for bounty rewards</li><li>From the budget, determine three tiers of rewards:<ul><li>smallest reward you are willing to give out</li><li>highest reward that&rsquo;s usually awardable</li><li>an extra range to be awarded in case of very severe vulnerabilities</li></ul></li><li>Determine who the bounty judges are (3 may be ideal typically)</li><li>Lead developer should probably be one of the bounty judges</li><li>When a bug report is received, the lead developer, with advice from judges, should evaluate the<br>severity of the bug</li><li>Work at this stage should be in a private repo, and the issue filed on Github</li><li>If it&rsquo;s a bug that should be fixed, in the private repo, a developer should write a test case,<br>which should fail and thus confirm the bug</li><li>Developer should implement the fix and ensure the test now passes; writing additional tests as<br>needed</li><li>Show the bounty hunter the fix; merge the fix back to the public repo is one way</li><li>Determine if bounty hunter has any other feedback about the fix</li><li>Bounty judges determine the size of the reward, based on their evaluation of both the<br><em>likelihood</em> and <em>impact</em> of the bug.</li><li>Keep bounty participants informed throughout the process, and then strive to avoid delays in<br>sending them their reward</li></ul><p>For an example of the three tiers of rewards, see<br><a href=https://bounty.ethereum.org>Ethereum&rsquo;s Bounty Program</a>:</p><blockquote><p>The value of rewards paid out will vary depending on severity of impact. Rewards for minor<br>&lsquo;harmless&rsquo; bugs start at 0.05 BTC. Major bugs, for example leading to consensus issues, will be<br>rewarded up to 5 BTC. Much higher rewards are possible (up to 25 BTC) in case of very severe<br>vulnerabilities.</p></blockquote><h2 id=speed-bumps><a href=#speed-bumps>Speed bumps <a href=#speed-bumps></a></a></h2><p>Speed bumps slow down actions, so that if malicious actions occur, there is time to recover. For<br>example, <a href=https://github.com/slockit/DAO/>The DAO</a> required 27 days between a successful request<br>to split the DAO and the ability to do so. This ensured the funds were kept within the contract,<br>increasing the likelihood of recovery. In the case of the DAO, there was no effective action that<br>could be taken during the time given by the speed bump, but in combination with our other<br>techniques, they can be quite effective.</p><p>Example:</p><pre><code class=language-sol>struct RequestedWithdrawal {
    uint amount;
    uint time;
}

mapping (address =&gt; uint) private balances;
mapping (address =&gt; RequestedWithdrawal) private requestedWithdrawals;
uint constant withdrawalWaitPeriod = 28 days; // 4 weeks

function requestWithdrawal() public {
    if (balances[msg.sender] &gt; 0) {
        uint amountToWithdraw = balances[msg.sender];
        balances[msg.sender] = 0; // for simplicity, we withdraw everything;
        // presumably, the deposit function prevents new deposits when withdrawals are in progress

        requestedWithdrawals[msg.sender] = RequestedWithdrawal({
            amount: amountToWithdraw,
            time: block.timestamp
        });
    }
}

function withdraw() public {
    if(requestedWithdrawals[msg.sender].amount &gt; 0 &amp;&amp; block.timestamp &gt; requestedWithdrawals[msg.sender].time + withdrawalWaitPeriod) {
        uint amountToWithdraw = requestedWithdrawals[msg.sender].amount;
        requestedWithdrawals[msg.sender].amount = 0;

        require(msg.sender.send(amountToWithdraw));
    }
}
</code></pre><h2 id=upgradeability><a href=#upgradeability>Upgradeability <a href=#upgradeability></a></a></h2><p>!!! warning<br>Smart Contract upgradeability is an active area of research. There are many important<br>questions, and risks related to smart contract upgradeability. Do your research into the state of<br>the art. We welcome discussion on the<br><a href=https://github.com/ConsenSys/smart-contract-best-practices/issues/164>related issue</a>.</p><p>Code will need to be changed if errors are discovered or if improvements need to be made. It is no<br>good to discover a bug, but have no way to deal with it.</p><p>Designing an effective upgrade system for smart contracts is an area of active research, and we<br>won&rsquo;t be able to cover all of the complications in this document. However, two basic approaches are<br>most commonly used. The simpler of the two is to have a registry contract that holds the address of<br>the latest version of the contract. A more seamless approach for contract users is to have a<br>contract that forwards calls and data onto the latest version of the contract.</p><p>Whatever the technique, it&rsquo;s important to have modularization and good separation between<br>components, so that code changes do not break functionality, orphan data, or require substantial<br>costs to port. In particular, it is usually beneficial to separate complex logic from your data<br>storage, so that you do not have to recreate all of the data in order to change the functionality.</p><p>It&rsquo;s also critical to have a secure way for parties to decide to upgrade the code. Depending on<br>your contract, code changes may need to be approved by a single trusted party, a group of members,<br>or a vote of the full set of stakeholders. If this process can take some time, you will want to<br>consider if there are other ways to react more quickly in case of an attack, such as an<br>emergency stop or circuit-breaker.</p><p>Regardless of your approach, it is important to have some way to upgrade your contracts, or they<br>will become unusable when the inevitable bugs are discovered in them.</p><h4 id=example-1-use-a-registry-contract-to-store-the-latest-version-of-a-contract><a href=#example-1-use-a-registry-contract-to-store-the-latest-version-of-a-contract>Example 1: Use a registry contract to store the latest version of a contract <a href=#example-1-use-a-registry-contract-to-store-the-latest-version-of-a-contract></a></a></h4><p>In this example, the calls aren&rsquo;t forwarded, so users should fetch the current address each time<br>before interacting with it.</p><pre><code class=language-sol>pragma solidity ^0.5.0;

contract SomeRegister {
    address backendContract;
    address[] previousBackends;
    address owner;

    constructor() {
        owner = msg.sender;
    }

    modifier onlyOwner() {
        require(msg.sender == owner)
        _;
    }

    function changeBackend(address newBackend) public
    onlyOwner()
    returns (bool)
    {
        if(newBackend != address(0) &amp;&amp; newBackend != backendContract) {
            previousBackends.push(backendContract);
            backendContract = newBackend;
            return true;
        }

        return false;
    }
}
</code></pre><p>There are two main disadvantages to this approach:</p><ol><li>Users must always look up the current address, and anyone who fails to do so risks using an old<br>version of the contract</li><li>You will need to think carefully about how to deal with the contract data when you replace the<br>contract</li></ol><p>The alternate approach is to have a contract forward calls and data to the latest version of the<br>contract:</p><h4 id=example-2-use-a-delegatecallhttpethereumstackexchangecomquestions2404upgradeable-contracts-to-forward-data-and-calls><a href=#example-2-use-a-delegatecallhttpethereumstackexchangecomquestions2404upgradeable-contracts-to-forward-data-and-calls>Example 2: <a href=http://ethereum.stackexchange.com/questions/2404/upgradeable-contracts>Use a <code>DELEGATECALL</code></a> to forward data and calls <a href=#example-2-use-a-delegatecallhttpethereumstackexchangecomquestions2404upgradeable-contracts-to-forward-data-and-calls></a></a></h4><p>This approach relies on using the<br><a href=https://solidity.readthedocs.io/en/latest/contracts.html#fallback-function>fallback function</a> (in<br><code>Relay</code> contract) to forward the calls to a target contract (<code>LogicContract</code>) using<br><a href=https://solidity.readthedocs.io/en/latest/introduction-to-smart-contracts.html#delegatecall-callcode-and-libraries>delegatecall</a>.<br>Remember that <code>delegatecall</code> is a special function in Solidity that executes the logic of the<br>called address (<code>LogicContract</code>) in the context of the calling contract (<code>Relay</code>), so <em>&ldquo;storage,<br>current address and balance still refer to the calling contract , only the code is taken from the<br>called address&rdquo;</em>.</p><pre><code class=language-sol>pragma solidity ^0.5.0;

contract Relay {
    address public currentVersion;
    address public owner;

    modifier onlyOwner() {
        require(msg.sender == owner);
        _;
    }

    constructor(address initAddr) {
        require(initAddr != address(0));
        currentVersion = initAddr;
        owner = msg.sender; // this owner may be another contract with multisig, not a single contract owner
    }

    function changeContract(address newVersion) public
    onlyOwner()
    {
        require(newVersion != address(0));
        currentVersion = newVersion;
    }

    fallback() external payable {
        (bool success, ) = address(currentVersion).delegatecall(msg.data);
        require(success);
    }
}
</code></pre><pre><code class=language-sol>contract LogicContract {
    address public currentVersion;
    address public owner;
    uint public counter;

    function incrementCounter() {
        counter++;
    }
}
</code></pre><p>This simple version of the pattern cannot return values from <code>LogicContract</code>&rsquo;s functions, only<br>forward them, which limits its applicability. More complex implementations attempt to solve this<br>with in-line assembly code and a registry of return sizes. They are commonly referred to as<br><a href=https://blog.openzeppelin.com/proxy-patterns/>Proxy Patterns</a>, but are also known as<br><a href=https://github.com/PeterBorah/ether-router>Router</a>,<br><a href=https://gist.github.com/Arachnid/4ca9da48d51e23e5cfe0f0e14dd6318f>Dispatcher</a> and Relay. Each<br>implementation variant introduces a different set of complexity, risks and limitations.</p><p>You must be extremely careful with how you store data with this method. If your new contract has a<br>different storage layout than the first, your data may end up corrupted. When using more complex<br>implementations of <code>delegatecall</code>, you should carefully consider and understand*:</p><ul><li>How the EVM handles the<br><a href=https://docs.soliditylang.org/en/latest/internals/layout_in_storage.html>layout of state variables in storage</a>,<br>including packing multiple variables into a single storage slot if possible</li><li>How and why<br><a href=https://github.com/OpenZeppelin/openzeppelin-sdk/issues/37>the order of inheritance</a> impacts<br>the storage layout</li><li>Why the called contract (<code>LogicContract</code>) must have the same storage layout of the calling<br>contract (<code>Relay</code>), and only append new variables to the storage (see<br><a href=https://blog.trailofbits.com/2018/09/05/contract-upgrade-anti-patterns/>Background on delegatecall</a>)</li><li>Why a new version of the called contract (<code>LogicContract</code>)<br><a href=https://github.com/OpenZeppelin/openzeppelin-sdk/issues/37>must have the same storage layout as the previous version</a>,<br>and only append new variables to the storage</li><li><a href=https://blog.openzeppelin.com/towards-frictionless-upgradeability/>How a contract&rsquo;s constructor can affect upgradeability</a></li><li>How the ABI specifies<br><a href="https://solidity.readthedocs.io/en/v0.4.24/abi-spec.html?highlight=signature#function-selector">function selectors</a><br>and how<br><a href=https://medium.com/nomic-labs-blog/malicious-backdoors-in-ethereum-proxies-62629adf3357>function-name collision</a><br>can be used to exploit a contract that uses <code>delegatecall</code></li><li>How <code>delegatecall</code> to a non-existent contract will return true even if the called contract does<br>not exist. For more details see<br><a href=https://blog.trailofbits.com/2018/09/05/contract-upgrade-anti-patterns/>Breaking the proxy pattern</a><br>and Solidity docs on<br><a href=https://solidity.readthedocs.io/en/latest/control-structures.html#error-handling-assert-require-revert-and-exceptions>Error handling</a>.</li><li>Remember the<br><a href=https://diligence.consensys.net/blog/2019/01/upgradeability-is-a-bug/>importance of immutability to achieve truslessness</a></li></ul><p>* <em>Extended from<br><a href=https://blog.trailofbits.com/2018/09/05/contract-upgrade-anti-patterns/>Proxy pattern recommendations section</a></em></p></main></div><footer><span><b>Dwarves, LLC</b> Â© 2015 - 2023 All rights reserved.</span></footer><script src=https://cdnjs.cloudflare.com/ajax/libs/prism/1.26.0/components/prism-core.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/prism/1.26.0/plugins/autoloader/prism-autoloader.min.js></script></body></html>